---
title: "Title Goes Here"
author:
  - Jane Doe:
      correspondence: "yes"
      email: janedoe@fosg.org
      orcid: 0000-0003-1689-0557
      institute:
        - fosg
        - fop
  - John Q. Doe:
      institute: fosg
      orcid: 0000-0003-1689-0558
  - Peder Ås:
      institute: fosg
      orcid: 0000-0003-1689-0559
  - Juan Pérez:
      orcid: 0000-0003-1689-0551
      institute:
        - name: Acme Corporation
  - Max Mustermann:
      orcid: 0000-0003-1689-0552
institute:
  - fosg:
      name: Formatting Open Science Group
      address: 23 Science Street, Eureka, Mississippi, USA
  - fop: Federation of Planets
title-block-published: "Last updated"  
date: now
date-format: long
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: true
  warning: false
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 600
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

# Introduction

Here is a citation [@Marwick2017]

# Background

# Methods

# Results

<!-- Here's some example analysis code: -->

```{r}
#| label: get-data

library(tidyverse)
library(ggbeeswarm)
# This CSV file was downloaded from our data sheet here
# https://docs.google.com/spreadsheets/d/1Jwe3UqJyedrV-QWlwR_44__t4xBVrCfxGyhXdi3E0sg/edit?resourcekey#gid=1686084773
# note that you may need to download it again to get the latest updates!

jobdata <- read_csv(here::here('analysis/data/raw_data/Tenure Track Job Advertisements in Archaeology (Responses) - Form Responses 1.csv')) %>% 
  # simplify the column names 
  janitor::clean_names()

total_number_of_ads_in_our_sample <- nrow(jobdata)
```

We have `r total_number_of_ads_in_our_sample` job advertisements in our sample

```{r}
#| label: fig-how-many-jobs-per-year
#| fig-cap: "Number of tenure-track archaeology faculty job ads posted each year"

# we can get the year from the URL to the Academic Job Ads Wiki

year_ad_posted <- 
jobdata %>% 
  pull(url_to_data_source_e_g_paste_in_url_to_the_jobs_wiki_page) %>% 
  str_extract(.,  "[[0-9]]{4}-[[0-9]]{4}|2021-22") %>% 
  str_replace("2021-22",  "2021-2022")
 # fix for 2021-22 DONE!
 # fix for 2023 DONE!

jobdata <- 
  jobdata %>% 
  mutate(year_ad_posted = year_ad_posted) %>% 
  drop_na(year_ad_posted)

ggplot(jobdata) +
  aes(year_ad_posted) +
  geom_bar() +
  scale_x_discrete(name = "Academic Year") +
  theme_minimal()
```

@fig-how-many-jobs-per-year shows how many jobs per year in our sample

```{r}
#| label: fig-how-many-jobs-per-year-by-rank
#| fig-cap: "Proportion of tenure-track archaeology faculty jobs per year by rank"

# how many jobs of each rank per year?

jobdata <-
jobdata %>%
  # simplify rank descriptions
  mutate(title_of_position_tenure_track_jobs_only = tolower(title_of_position_tenure_track_jobs_only)) %>%
  mutate(job_title_simple = case_when(
   str_detect(title_of_position_tenure_track_jobs_only,
              "assistant prof|asst. prof|asst prof") ~ "Assistant Professor",
   str_detect(title_of_position_tenure_track_jobs_only,
              "associate prof|assoc. prof") ~ "Associate Professor",
   str_detect(title_of_position_tenure_track_jobs_only,
              "full prof") ~ "Full Professor",
   str_detect(title_of_position_tenure_track_jobs_only,
              "assistant or associate prof|assistant/associate prof") ~ "Assistant or Associate Professor",
   str_detect(title_of_position_tenure_track_jobs_only,
              "open rank|open-rank|assistant, associate, or full prof|assistant prof, associate prof, or prof") ~ "Open Rank",
   .default = "Other"))

# explore over time
jobdata %>%
  group_by(year_ad_posted) %>%
  count(job_title_simple) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot() +
  aes(year_ad_posted,
      prop,
      group = job_title_simple,
      colour = job_title_simple) +
  geom_line() +
  theme_minimal() +
  theme(legend.position = c(0.2, 0.8))

```


```{r}
#| label: ratio-tt-to-non-tt

# ratio of tenure-track to untenured positions
# base URL changes after 2018_2019

base_url_to_2019 <- "https://academicjobs.fandom.com/wiki/Archaeology_Jobs_"
base_url_after_2020 <- "https://academicjobs.fandom.com/wiki/Archaeology_"

# starts at 2010-2011
# fix for 2021-22
# base UR

years_to_2019 <- map_chr(2010:2019, ~str_glue('{.x}-{.x +1}'))
years_after_2020 <- map_chr(2020:2023, ~str_glue('{.x}-{.x +1}'))
# though it seems to start at 2007-8: https://academicjobs.fandom.com/wiki/Archaeology_07-08

# make a set of URLs for each page for each year
urls_for_each_year <- c(str_glue('{base_url_to_2019}{years_to_2019}'), 
                        str_glue('{base_url_after_2020}{years_after_2020}')) %>% 
    str_replace("2021-2022", "2021-22")

library(rvest)

# all years
urls_for_each_year_headers <- 
map(urls_for_each_year,
    ~.x %>% 
      read_html() %>% 
      html_nodes('.mw-headline') %>% 
      html_text())

# keep only headings that are actual jobs, they include the terms:
job_headings <- c("college", "university")

total_number_of_jobs_per_year <- 
  map(urls_for_each_year_headers,
      ~str_subset(tolower(.x),
          paste0(job_headings, collapse = "|")))

total_number_of_jobs_per_year_n <- 
map_int(total_number_of_jobs_per_year, length)

total_number_of_jobs_per_year_tbl <- 
tibble(
  url_to_data_source_e_g_paste_in_url_to_the_jobs_wiki_page = urls_for_each_year,
  total_number_of_jobs_per_year = total_number_of_jobs_per_year_n
)

# count of TT jobs per year from our manual data collection,
# join with our total number of all jobs by scraping
count_of_tt_jobs_per_year_from_our_form <- 
jobdata %>% 
  group_by(url_to_data_source_e_g_paste_in_url_to_the_jobs_wiki_page) %>% 
  tally() %>% 
  left_join(total_number_of_jobs_per_year_tbl) %>% 
  rename(n_tt_jobs  = n,
         n_total_jobs = total_number_of_jobs_per_year) %>% 
  mutate(n_non_tt_jobs = n_total_jobs - n_tt_jobs,
         ratio_tt_2_ntt = n_tt_jobs / n_non_tt_jobs) %>% 
  mutate(year = str_extract(url_to_data_source_e_g_paste_in_url_to_the_jobs_wiki_page,  "[[0-9]]{4}-[[0-9]]{4}|2021-22")) %>%  
  mutate(year = ifelse(year =="2021-22",  "2021-2022", year))

# draw plot
  ggplot(count_of_tt_jobs_per_year_from_our_form) +
  aes(year, 
      group = 1,
      ratio_tt_2_ntt) +
  geom_line() +
  geom_hline(yintercept = 1,
             colour = "red") +
  labs(y = "Ratio of tenure-track to\nnon-tenure track and othe\njobs in Archaeology",
       x = "") +
  theme_bw(base_size = 16)
  


```

```{r}
#| label: documents-requested

jobdata %>% 
  select(starts_with("documents_requested")) %>% 
  pivot_longer(everything()) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  mutate(value = case_when(
    value == "Not requested in the job ad" ~ 0,
    value == "One" ~ 1,
    value == "Two (e.g. two syllabi)" ~ 2,
    value == "Three" ~ 3,
    .default = 0
  )) %>% 
  ggplot() +
  aes(value,
      n) +
  geom_col() +
  facet_wrap( ~ name) 
```

```{r}
#| label: fig-requirements-over-time

jobdata_requirements <- 
jobdata %>% 
  select(year_ad_posted,
         starts_with("documents_requested")) %>% 
  pivot_longer(-year_ad_posted) %>% 
  mutate(value = case_when(
    value == "Not requested in the job ad" ~ 0,
    value == "One" ~ 1,
    value == "Two (e.g. two syllabi)" ~ 2,
    value == "Three" ~ 3,
    .default = 0
  ))  %>% 
  # trim names a bit
  mutate(name = str_remove(name, "documents_requested_"))

jobdata_requirements_means <- 
jobdata_requirements %>% # average number requested per year
  group_by(year_ad_posted, 
           name) %>% 
  summarise(mean_n = mean(value))

ggplot(jobdata_requirements_means) +
  aes(year_ad_posted, 
      mean_n,
      group = name) +
  geom_line() +
  geom_jitter(data = jobdata_requirements,
             aes(year_ad_posted, 
                 value),
             alpha = 0.1,
             height = 0.2,
             width =  0.1) +
  facet_wrap(~name,
             scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) 
  
  
```



```{r}
#| label: fig-requirements-by-position 

# do the requirements differ for associate positions 
jobdata %>% 
  mutate(position_title = case_when(
    str_detect(title_of_position_tenure_track_jobs_only, "Associate") ~ "Associate",
    str_detect(title_of_position_tenure_track_jobs_only, "Assistant") ~ "Assistant")) %>% 
  select(position_title,
         starts_with("documents_requested")) %>% 
  pivot_longer(-position_title) %>% 
  mutate(value = case_when(
    value == "Not requested in the job ad" ~ 0,
    value == "One" ~ 1,
    value == "Two (e.g. two syllabi)" ~ 2,
    value == "Three" ~ 3,
    .default = 0
  )) %>% 
  filter(!is.na(position_title)) %>% 
  ggplot() +
  aes(position_title,
      value
      ) +
    geom_jitter(height = 0.05) +
  facet_wrap( ~ name)
```


# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
